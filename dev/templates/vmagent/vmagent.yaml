apiVersion: apps/v1
kind: Deployment
metadata:
  name: vmagent
  labels:
    app.kubernetes.io/name: vmagent
    helm.sh/chart: vmagent-0.1.0
    app.kubernetes.io/instance: my-release
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: vmagent
      app.kubernetes.io/instance: my-release
  template:
    metadata:
      labels:
        app.kubernetes.io/name: vmagent
        app.kubernetes.io/instance: my-release
    spec:
      containers:
        - name: vmagent
          image: "victoriametrics/vmagent:latest"
          imagePullPolicy: IfNotPresent
          args:
            - "--promscrape.config=/etc/vmagent/vmagent.yml"
            - "--remoteWrite.url=http://example.com/remoteWrite"
          ports:
            - name: http
              containerPort: 8429
          volumeMounts:
            - name: vmagent-config
              mountPath: /etc/vmagent
      volumes:
        - name: vmagent-config
          configMap:
            name: my-vmagent-config
            items:
              - key: vmagent.yml
                path: vmagent.yml
---
apiVersion: v1
kind: Service
metadata:
  name: my-vmagent
  labels:
    app.kubernetes.io/name: vmagent
    app.kubernetes.io/instance: my-release
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: vmagent
    app.kubernetes.io/instance: my-release
  ports:
    - port: 8429
      targetPort: 8429
      protocol: TCP
      nodePort: 30092
      name: http
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-vmagent-config
  labels:
    app.kubernetes.io/name: vmagent
    app.kubernetes.io/instance: my-release
data:
  vmagent.yml: |-
    # Configurações do VictoriaMetrics vmagent
    remote_write:
      - url: "http://example.com/remoteWrite"
    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
